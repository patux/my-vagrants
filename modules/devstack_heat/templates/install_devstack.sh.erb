#!/bin/bash
. /etc/environment
git clone https://github.com/openstack-dev/devstack.git -b <%= @devstack_branch %> devstack
cd devstack
echo ADMIN_PASSWORD=password > localrc
echo MYSQL_PASSWORD=password >> localrc
echo RABBIT_PASSWORD=password >> localrc
echo SERVICE_PASSWORD=password >> localrc
echo SERVICE_TOKEN=tokentoken >> localrc
# Enable Heat
#echo ENABLED_SERVICES+=,heat,h-api,h-api-cfn,h-api-cw,h-eng,ceilometer-acompute,ceilometer-acentral,ceilometer-collector,ceilometer-api >> localrc 
echo ENABLED_SERVICES+=,c-api,c-sch,c-vol,ceilometer-acentral,ceilometer-acompute,ceilometer-api,ceilometer-collector,cinder,g-api,g-reg,h-api,h-api-cfn,h-api-cw,h-eng,heat,horizon,key,mysql,n-api,n-cauth,n-cond,n-cpu,n-crt,n-novnc,n-obj,n-sch,n-xvnc,q-agt,q-dhcp,q-l3,q-lbaas,q-meta,q-svc,quantum,rabbit,sysstat >> localrc
# echo IMAGE_URLS+=",http://gmw-gorozco1.zpn.intel.com/oc-images/cirros-0.3.0-x86_64-uec.tar.gz,http://gmw-gorozco1.zpn.intel.com/oc-images/F17-i386-cfntools.qcow2,http://gmw-gorozco1.zpn.intel.com/oc-images/F17-x86_64-cfntools.qcow2,http://gmw-gorozco1.zpn.intel.com/oc-images/F18-i386-cfntools.qcow2,http://gmw-gorozco1.zpn.intel.com/oc-images/F18-x86_64-cfntools.qcow2" >> localrc
echo IMAGE_URLS+=",http://gmw-gorozco1.zpn.intel.com/oc-images/cirros-0.3.0-x86_64-uec.tar.gz,http://gmw-gorozco1.zpn.intel.com/oc-images/F17-i386-cfntools.qcow2,http://gmw-gorozco1.zpn.intel.com/oc-images/F17-x86_64-cfntools.qcow2,http://gmw-gorozco1.zpn.intel.com/oc-images/F18-i386-cfntools.qcow2,http://gmw-gorozco1.zpn.intel.com/oc-images/F18-x86_64-cfntools.qcow2,http://gmw-gorozco1.zpn.intel.com/oc-images/U12-x86_64-cfntools.qcow2,http://gmw-gorozco1.zpn.intel.com/oc-images/S11-sp2-x86_64-cfntools.qcow2"  >> localrc
echo disable_service n-net >> localrc

# Optionally alter HEAT_REPO to use a fork.
# HEAT_REPO=https://github.com/sjcorbett/heat.git
# HEAT_BRANCH=master
#
echo "# Network configuration. HOST_IP should be the same as the IP you used" >> localrc
echo "# for the private network in your Vagrantfile. The combination of" >> localrc
echo "# FLAT_INTERFACE and PUBLIC_INTERFACE indicates that OpenStack should" >> localrc
echo "# bridge network traffic over eth1." >> localrc
<% if has_variable?("ipaddress_eth1") %><% then %>
echo HOST_IP=<%= @ipaddress_eth1 %> >> localrc
echo PUBLIC_INTERFACE=eth1 >> localrc
echo HOST_IP_IFACE=eth1 >> localrc
<% else %>
echo HOST_IP=<%= @ipaddress_eth0 %> >> localrc
echo PUBLIC_INTERFACE=eth0 >> localrc
echo HOST_IP_IFACE=eth0 >> localrc
<% end %>
echo FLOATING_RANGE=`echo $HOST_IP | cut -d'.' -f1-3`.224/27 >> localrc
echo FLAT_INTERFACE=br100 >> localrc
echo EXTRA_OPTS=\(scheduler_default_filters=AllHostsFilter\) >> localrc
./stack.sh
echo "OFFLINE=True" >> localrc
